<?xml version="1.0" encoding="UTF-8"?>
<report title="Groups list" description="Lists groups.">
  <query website_filter_field="g.website_id">
    SELECT #columns#
    FROM groups g
    LEFT JOIN groups_users guc ON guc.group_id=g.id AND guc.deleted=false
    LEFT JOIN groups_users gu ON gu.group_id=g.id AND gu.deleted=false AND gu.user_id=#currentUser#
    #joins#
    WHERE g.deleted = false
  </query>
  <order_bys>
    <order_by>g.title</order_by>
  </order_bys>
  <params>
    <param name="currentUser" display="Current User ID" description="Current user's warehouse ID." datatype="text" emptyvalue="0"/>
    <param name="userFilterMode" display="userFilterMode" description="Include which groups for the user?"
        datatype="lookup" default="member" 
        lookup_values='all:All groups,joinable:Groups they can join or request,pending:Groups they are pending approval to join,member:Groups they are a member of,admin:Groups they administer,create:Groups they created,create_admin:Groups they created or administer'>
      <wheres>
        <where value="joinable" operator="equal">g.joining_method&lt;&gt;'I'</where>
        <where value="pending" operator="equal">gu.id is not null AND gu.pending=true</where>
        <where value="member" operator="equal">gu.id is not null AND gu.pending=false</where>
        <where value="admin" operator="equal">gu.id is not null AND gu.pending=false AND gu.administrator=true</where>
        <where value="create" operator="equal">gu.id is not null AND gu.created_by_id=#currentUser#</where>
        <where value="create_admin" operator="equal">gu.id is not null AND (gu.created_by_id=#currentUser# OR gu.administrator=true)</where>
      </wheres>
    </param>
    <param name="group_type_id" display="Group Type" description="Limit the report to a certain type of group" datatype="lookup"
            population_call='report:library/terms/terms_list:id:term:termlist_external_key=indicia:group_types,termlist_id='
            default="">
      <where>g.group_type_id=#group_type_id#</where>
    </param>
    <param name="from_group_id" display="From parent group" description="Only include groups which are linked to from another group (e.g. an organisation which parents a list of projects)."
        datatype="text" default="">
      <join>JOIN group_relations grfrom ON grfrom.to_group_id=g.id AND grfrom.from_group_id=#from_group_id# AND grfrom.deleted=false</join>      
    </param>
  </params>
  <columns>
    <column name="id" visible="false" sql="g.id" datatype="integer" in_count="true" />
    <column name="title" display="Name" sql="g.title" datatype="text" />
    <column name="description" display="Description" sql="g.description" datatype="text" />
    <column name="administrator" display="Admin" sql="gu.id is not null  AND gu.pending=false AND gu.administrator=true" datatype="boolean" visible="false" />
    <column name="pending" display="Pending" sql="gu.id is not null AND gu.pending=true" datatype="boolean" visible="false" />
    <column name="member" display="Member" sql="gu.id is not null AND gu.pending=false" datatype="boolean" visible="false" />
    <column name="nonmember" display="Non-member" sql="gu.id is null or gu.pending=false" datatype="boolean" visible="false" />
    <column name="canrequestorjoin" display="Can request membership or join" sql="gu.id is null and g.joining_method in ('R','P')" datatype="boolean" visible="false" />
    <column name="private_records" display="Records released" sql="not g.private_records" datatype="boolean" />
    <column name="role" display="Role" sql="case when gu.administrator=true then 'Administrator' when gu.id is not null and gu.pending=false then 'Member' when gu.id is not null and gu.pending=true then 'Awaiting approval' end" datatype="boolean" />
    <column name="joining_method" display="Joining method" sql="case g.joining_method when 'P' then 'Public' when 'R' then 'By request' when 'I' then 'Invite only' end" datatype="text" />
    <column name="members" display="Members" sql="count(DISTINCT guc.user_id)" datatype="integer" aggregate="true" />
  </columns>
</report>
