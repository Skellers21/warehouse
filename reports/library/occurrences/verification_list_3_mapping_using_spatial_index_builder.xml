<report
    title="Verification map report 3 using index_locations_samples "
    description="List of occurrences for the verification map."
>
  <query website_filter_field="o.website_id">
  SELECT #columns#
  FROM cache_occurrences o
  JOIN occurrences xo ON xo.id=o.id AND xo.deleted=false
  JOIN samples s on s.id=xo.sample_id
  JOIN websites w on w.id=xo.website_id
  LEFT JOIN occurrence_comments oc 
      ON oc.occurrence_id=o.id 
      AND oc.implies_manual_check_required=true 
      AND oc.deleted=false
  #agreements_join#
  #joins#
  WHERE #sharing_filter# 
  AND ('#records#' = 'all'
    OR ('#records#' IN ('unverified','fail') AND xo.record_status IN ('C','S'))
    OR ('#records#'='verified' AND xo.record_status='V')
    OR ('#records#'='dubious' AND xo.record_status='D')
    OR ('#records#'='rejected' AND xo.record_status='R'))
  AND (
    ('#certainty#'='C' and (o.certainty = 'C' or o.certainty is null))
    OR ('#certainty#'='L' and (o.certainty in ('C','L') or o.certainty is null))
    OR ('#certainty#'='U')
  )
  AND ('#records#'&lt;&gt;'fail' OR oc.occurrence_id is not null)
  AND ('#searchArea#'='' OR st_intersects(s.geom, st_geomfromtext('#searchArea#',900913)))
  #idlist#
  </query>
  <order_bys>
    <order_by>o.id DESC</order_by>
  </order_bys>
  <params>
    <param name='smpattrs' display='Sample attribute list' description='Comma separated list of sample attribute IDs to include' datatype='smpattrs' />
    <param name='occattrs' display='Occurrence attribute list' description='Comma separated list of occurrence attribute IDs to include' datatype='occattrs' />
    <param name='records' display='Records to include' datatype='lookup'
        lookup_values='unverified:All unverified records,fail:Unverified records failing automated checks,verified:All verified records,dubious:All dubious records,rejected:All rejected records,all:All records' />
    <param name='certainty' display='and record was' datatype='lookup'
        lookup_values='C:Certain,L:Certain or likely,U:Uncertain or better' />
    <param name='searchArea' display='Report Search Area' datatype='geometry' allow_buffer='true' />
    <param name='idlist' display='List of IDs' description='Comma separated list of occurrence IDs to filter to.' datatype='idlist' fieldname='o.id' alias='occurrence_id' />
    <param name='expertise_location' display='Location of Expertise' description='Provide the location in which your expertise applies' datatype='lookup' 
        population_call='direct:location:id:name'>
      <join>JOIN index_locations_samples lfilter ON lfilter.sample_id=o.sample_id and lfilter.location_id=#expertise_location#</join>
    </param>
    <param name="expertise_taxon_groups" display="Taxon Group Expertise" description="List of taxon group IDs which the user has expertise in" datatype="text">
      <where>o.taxon_group_id IN (#expertise_taxon_groups#)</where>
    </param>
    <param name='expertise_surveys' display='Survey IDs list' description='Comma separated list of surveys IDs to include' datatype='text'>
      <where>s.survey_id in (#expertise_surveys#)</where>  
    </param>
  </params>
  <columns>
    <column name='occurrence_id' display='ID' sql='o.id' datatype='integer' in_count="true" />    
    <column name='geom' visible='false' mappable="true" sql='st_astext(coalesce(s.geom, o.public_geom))' />
    <column name='fo' visible='false' feature_style="fillOpacity" sql='round(length(o.public_entered_sref) / 24.0, 2)' />
    <column name='sc' visible='false' feature_style="strokeColor" sql="case xo.record_status when 'C' then 
      case o.certainty when 'C' then 'green' when 'L' then 'orange' when 'U' then 'red' else 'blue' end
    when 'V' then 'green'
    when 'D' then 'orange'
    when 'R' then 'red'
    else 'black' end" />
    <column name='fc' visible='false' feature_style="fillColor" sql="case xo.record_status when 'V' then 'green' when 'D' then 'orange' when 'R' then 'red' else 'blue' end" />    
    <column name='zi' visible='false' feature_style='graphicZIndex' sql='length(o.public_entered_sref)' />
  </columns>
</report>
